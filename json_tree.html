<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body { margin: 0; overflow: hidden; background: #fafafa; font-family: "Noto Sans JP", sans-serif; }
  .node circle { fill: #ffd966; stroke: #999; stroke-width: 1.5px; }
  .link { fill: none; stroke: #ccc; stroke-opacity: 0.6; stroke-width: 1.2px; }
  .label { font-size: 11px; pointer-events: none; fill: #333; }
</style>
<body>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const width = window.innerWidth;
const height = window.innerHeight;

const svg = d3.select("body")
  .append("svg")
  .attr("width", width)
  .attr("height", height);

const jsonData = JSON.parse(`__JSON_DATA__`);

// JSONをツリー構造に変換
const root = d3.hierarchy(jsonData, d =>
  typeof d === "object" && d !== null
    ? (Array.isArray(d)
        ? d.map((v, i) => ({ key: `[${i}]`, value: v }))
        : Object.entries(d).map(([k, v]) => ({ key: k, value: v })))
    : null
);

root.each(d => {
  d.name =
    d.data && d.data.key !== undefined
      ? d.data.key
      : (d.parent ? "value" : "root");
});

// レイアウト設定
const treeLayout = d3.tree().size([height - 60, width - 250]);
treeLayout(root);

// リンク描画
svg.selectAll(".link")
  .data(root.links())
  .join("path")
  .attr("class", "link")
  .attr("d", d3.linkHorizontal()
    .x(d => d.y)
    .y(d => d.x)
  );

// ノード描画
const node = svg.selectAll(".node")
  .data(root.descendants())
  .join("g")
  .attr("class", "node")
  .attr("transform", d => `translate(${d.y},${d.x})`);

node.append("circle").attr("r", 5);

// ラベル（キー＋値）
node.append("text")
  .attr("dx", 10)
  .attr("dy", 3)
  .attr("class", "label")
  .text(d => {
    const v = d.data.value;
    if (v === null) return `${d.name}: null`;
    if (typeof v === "object") return d.name;
    return `${d.name}: ${v}`;
  });
</script>
</body>
